<template>
    <div class="client-video-download-section">
        <v-container grid-list-lg class="client-story-detail-section" pt-0>
            <v-layout row wrap v-if="story">
                <v-flex xs12 pt-0>
                    <v-btn outline @click="onGoback()" class="ml-0">
                        <v-icon>chevron_left</v-icon>
                        Go back
                    </v-btn>
                </v-flex>

                <v-flex xs12 sm12 md5 lg4 xl4 class="client-assets">
                    <h2>Assets</h2>

                    <v-divider style="margin-bottom:20px;"></v-divider>

                    <v-layout row wrap>
                        <asset-component v-for="asset in story.assets"
                                         :key="asset.id"
                                         :asset="asset"
                                         :assets="story.assets"
                                         :story_id="story.id"></asset-component>
                    </v-layout>

                    <v-btn
                            block
                            dark
                            :loading="loading"
                            :disabled="loading"
                            large
                            @click.native="onDownloadAllAssets()"
                            color="dark">Download assets

                    </v-btn>
                </v-flex>

                <v-flex xs12 sm12 md7 lg8 xl8>
                    <div class="story-content">
                        <v-badge right color="black" v-if="order">
                            <span slot="badge"><v-icon dark color="white">done</v-icon></span>
                            <h2 v-html="story.title"></h2>
                        </v-badge>
                        <h2 v-html="story.title" v-else></h2>

                        <div class="caption">
                            <span>Author: {{ story.author }} | </span>
                            <span>Created at: {{ dateFormater(story.date_ingested) }}</span><br/>
                            <!--<span>State: <strong>{{ story.state }}</strong> |</span>-->
                            <!--<span>Status : {{ story.status }}</span>-->
                        </div>

                        <v-divider style="margin: 15px 0"></v-divider>

                        <div v-html="story.description"></div>
                    </div>
                </v-flex>

            </v-layout>
        </v-container>
    </div>
</template>

<script>
    import AssetComponent from '../partials/AssetStoryComponent';
    import VideoReloadServices from '../../../../services/VideoReloadServices';
    export default {
        components: {
            assetComponent: AssetComponent
        },

        data() {
            return {
                story: '',
                loading: false,
                loader: null,
                order: false,
            }
        },

        created() {
            this.getStoryDetail();

            var video_reload = new VideoReloadServices();
            video_reload.reloadAll();

        },

        watch: {
            loader () {
                const l = this.loader
                this[l] = !this[l]

                setTimeout(() => (this[l] = false), 3000)

                this.loader = null
            }
        },

        methods: {
            onGoback() {

                if (this.$route.query.mailer_id !== undefined) {
                    this.$router.push({name: 'client_stories'});
                } else {
                    this.$router.go(-1);
                }
            },

            getStoryDetail(){
                let alpha_id = this.$route.params.alpha_id;

                this.$store.dispatch('getCurrentStory', alpha_id)
                    .then(() => {
                        this.story = this.$store.getters.getCurrentStory;
                        console.log(this.story);
                        if (this.story.orders && this.story.orders.id) {
                            this.order = true;
                        }
                    });
            },

            onDownloadAllAssets(){
                var client_mailer_id = this.$store.getters.getClientMailerId;
                if (client_mailer_id == '') {
                    client_mailer_id = this.$route.query.mailer_id;
                }

                this.loader = 'loading';
                var url = '/client/stories/' + this.story.id + '/download/?mailer_id=' + client_mailer_id;
                window.location = url;
            },


            dateFormater(date){
                var current_date = new Date(Date.parse(date.replace('-', '/', 'g')));
                return current_date.toDateString();
            }
        }
    }
</script>