<?php

namespace App\Services;

use App\Jobs\QueueVideo;
use App\Libraries\VideoHelper;
use App\Video;
use Illuminate\Http\UploadedFile;

class VideoService
{
    /**
     * @param Video $video
     * @param UploadedFile $uploadedVideoFile
     * @return bool
     */
    public function saveUploadedVideoFile(Video $video, UploadedFile $uploadedVideoFile)
    {
        // TODO: avoid user input in the file name
        $fileOriginalName = strtolower(preg_replace('/[^a-zA-Z0-9-_\.]/', '', pathinfo($uploadedVideoFile->getClientOriginalName(), PATHINFO_FILENAME)));
        $fileName = time() . '-' . $fileOriginalName . '.' . $uploadedVideoFile->getClientOriginalExtension();
        $fileMimeType = $uploadedVideoFile->getMimeType();

        // Upload to S3
        \Storage::disk('s3')->put($fileName, file_get_contents($uploadedVideoFile), 'public');
        $filePath = \Storage::disk('s3')->url($fileName);

        // Send video to queue for watermarking
        QueueVideo::dispatch($video->id)->delay(now()->addSeconds(5));

        $video->file = $filePath;
        $video->mime = $fileMimeType;
        $video->save();

        return $filePath;
    }

    /**
     * @param Video $video
     * @param string $videoUrl
     * @return string
     */
    public function saveVideoLink(Video $video, string $videoUrl = null)
    {
        if (!$videoUrl) {
            $video->url = null;
            $video->youtube_id = null;
            $video->image = null;
            $video->thumb = null;
            $video->save();
            return null;
        }
        $linkDetails = VideoHelper::videoLinkChecker($videoUrl);

        $video->youtube_id = $linkDetails['youtube_id'];
        $video->image = $linkDetails['image'];
        $video->thumb = $linkDetails['thumb'];
        $video->embed_code = $linkDetails['embed_code'];
        $video->url = $linkDetails['url'];
        $video->vertical = $linkDetails['vertical'];
        $video->save();

        return $video->url;
    }
}